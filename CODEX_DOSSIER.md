# ResumeOS - Complete Codex Dossier

> **Generated**: 2026-01-06
> **Generated By**: Claude Code
> **Purpose**: Full project context transfer to OpenAI Codex
> **Repository**: resumeos_26_app

---

## Executive Summary

### What Is This Project?

ResumeOS is a conversational resume customization application that helps users create tailored resumes for specific job descriptions. Users paste a job description, and the system guides them through building a resume section by section, using semantic search to find the most relevant content from a pre-built database.

**Core Principle**: The system ONLY selects and reframes existing content from the database. It NEVER fabricates new achievements, metrics, or experiences. This "honesty constraint" is enforced by a Validator agent that checks all AI-generated content against source material.

The application has evolved through multiple versions:
- **V1**: Single writer agent, monolithic approach
- **V2**: 4-agent system (JD Strategist, Content Selector, Gap Analyzer, Writer, Validator)
- **V2.1** (Current): 6-agent system with two-phase writing and exclusive content allocation

### Current State

- **Version**: V2.1 (production-ready)
- **Deployment**: Vercel at resumeos.vercel.app
- **Status**: Fully functional with interactive editing

### Recent Focus (Last 24 Hours)

Intensive V2.1 implementation including:
- Interactive resume editing experience (`/v2.1/view/[sessionId]`)
- Two-phase writer architecture (Narrative Writer + Detail Writer)
- DOCX export functionality
- Comprehensive diagnostics system
- Bug fixes for word count calculations and React hooks

### Key Challenges Addressed

1. **Content Duplication**: V2 allowed the same metrics to appear in multiple sections. V2.1 introduces exclusive content allocation.
2. **Hallucinated Structure**: V2 let AI generate header/position details. V2.1 uses Assembler to pull structure from database.
3. **Robotic Voice**: Added dedicated Voice Guide for consistent personality.
4. **Word Count Violations**: Added strict word count validation in prompts and validator.

---

## Architecture

### High-Level Architecture

```
User Input (Job Description)
         |
         v
+------------------+
|  JD Strategist   |  <- Agent 1: Analyzes JD, extracts requirements
+------------------+
         |
         v
+------------------+
| Content Selector |  <- Code: Semantic search + scoring
+------------------+
         |
         v
+------------------+
| Content Allocator|  <- Code (V2.1): Exclusive slot assignment
+------------------+
         |
         v
+------------------+
|   Gap Analyzer   |  <- Agent 2: Coverage analysis
+------------------+
         |
[User Intervention - Review gaps, provide context]
         |
         v
+------------------+
| Narrative Writer |  <- Agent 3 (Phase 1): Summary + Career Highlights
+------------------+
         |
         v
+------------------+
|  Detail Writer   |  <- Agent 4 (Phase 2): P1/P2 overviews + bullets
+------------------+
         |
         v
+------------------+
|    Validator     |  <- Agent 5: Honesty, coverage, format checks
+------------------+
         |
         v
+------------------+
|    Assembler     |  <- Code: Combines AI + DB into final resume
+------------------+
         |
         v
Final Resume (JSON + DOCX)
```

### System Components

#### Frontend
- **Framework**: Next.js 14 with App Router
- **UI Library**: React 18
- **Styling**: Tailwind CSS
- **Component Library**: shadcn/ui
- **State Management**: Zustand (for legacy V1), React state for V2.1
- **Icons**: Lucide React

#### Backend
- **Runtime**: Node.js (Vercel Edge/Serverless)
- **API Style**: REST with Next.js API routes
- **Max Duration**: 180 seconds for pipeline endpoints

#### Database
- **Type**: PostgreSQL (Vercel Postgres with pgvector)
- **ORM**: Drizzle ORM
- **Embeddings**: OpenAI text-embedding-3-small
- **Vector Search**: pgvector extension

#### External Services
- **LLM**: Anthropic Claude (claude-sonnet-4-20250514)
- **Embeddings**: OpenAI API
- **File Generation**: docx library

---

## Directory Structure

```
resumeos_26_app/
├── src/
│   ├── app/
│   │   ├── page.tsx                      # Sessions dashboard (home)
│   │   ├── layout.tsx                    # Root layout
│   │   ├── v2.1/
│   │   │   ├── page.tsx                  # V2.1 generation flow
│   │   │   ├── view/[sessionId]/page.tsx # Interactive editing
│   │   │   └── diagnostics/[sessionId]/page.tsx
│   │   └── api/
│   │       ├── v2/                       # Legacy V2 endpoints
│   │       │   ├── pipeline/
│   │       │   │   ├── start/route.ts
│   │       │   │   └── generate/route.ts
│   │       │   ├── sessions/route.ts
│   │       │   ├── approve/route.ts
│   │       │   └── diagnostics/[sessionId]/route.ts
│   │       └── v2.1/                     # V2.1 endpoints
│   │           ├── pipeline/
│   │           │   ├── start/route.ts    # Analysis phase
│   │           │   └── generate/route.ts # Generation phase
│   │           ├── session/[id]/route.ts # Session CRUD
│   │           ├── refine/route.ts       # AI refinement
│   │           ├── export-docx/route.ts  # DOCX generation
│   │           └── content-bank/route.ts # Content library
│   ├── components/
│   │   ├── v21/
│   │   │   ├── InteractiveResume.tsx     # Clickable resume view
│   │   │   ├── SectionEditor.tsx         # Modal editor
│   │   │   └── ContentBankSidebar.tsx    # Content browser
│   │   ├── resume/
│   │   │   └── v2/
│   │   │       └── GapReview.tsx
│   │   └── ui/                           # shadcn/ui components
│   ├── lib/
│   │   ├── agents/
│   │   │   ├── config.ts                 # Agent configuration
│   │   │   ├── jd-strategist.ts          # JD analysis agent
│   │   │   ├── narrative-writer.ts       # Phase 1 writer
│   │   │   ├── detail-writer.ts          # Phase 2 writer
│   │   │   ├── gap-analyzer.ts           # Coverage analysis
│   │   │   └── validator-v21.ts          # Validation agent
│   │   ├── pipeline/
│   │   │   ├── v2.1-pipeline.ts          # Main pipeline orchestrator
│   │   │   ├── content-allocator.ts      # Exclusive slot assignment
│   │   │   └── assembler.ts              # Final resume assembly
│   │   ├── prompts/
│   │   │   ├── voice-guide.ts            # Umberto's voice/personality
│   │   │   ├── narrative-writer-prompt.ts
│   │   │   ├── detail-writer-prompt.ts
│   │   │   └── jd-strategist-prompt.ts
│   │   ├── data/
│   │   │   └── umberto-profile.ts        # Static profile data
│   │   ├── content-selector-v2.ts        # Semantic search + scoring
│   │   ├── rules.ts                      # Conflict map, format rules
│   │   ├── db.ts                         # Database connection
│   │   ├── openai.ts                     # OpenAI client
│   │   ├── claude.ts                     # Anthropic client
│   │   ├── diagnostics.ts                # Logging system
│   │   ├── docx-export-v21.ts            # DOCX generation
│   │   └── utils.ts
│   ├── drizzle/
│   │   └── schema.ts                     # Database schema
│   ├── types/
│   │   ├── index.ts                      # Shared types
│   │   ├── v2.ts                         # V2 pipeline types
│   │   ├── v2.1.ts                       # V2.1 pipeline types
│   │   └── profile.ts                    # Profile types
│   └── data/
│       ├── master-content.json           # All resume content
│       └── variants.json                 # Content variants
├── docs/
│   └── RESUMEOS_V2.1_IMPLEMENTATION_PLAN.md
├── drizzle/                              # Migrations
├── scripts/
│   └── seed-database.ts
├── CLAUDE.md                             # Project instructions
├── HANDOFF.md                            # Session handoffs
├── package.json
├── next.config.mjs
├── tsconfig.json
├── drizzle.config.ts
└── tailwind.config.ts
```

---

## Key Type Definitions

### V2.1 Types (src/types/v2.1.ts)

```typescript
// Content Allocation - Exclusive slot assignment
export interface AllocatedSlot {
  slot: string;
  contentId: string;
  content: string;
  score: number;
}

export interface ContentAllocation {
  summaries: AllocatedSlot[];
  careerHighlights: AllocatedSlot[];
  position1Bullets: AllocatedSlot[];
  position2Bullets: AllocatedSlot[];
  position1Overview: AllocatedSlot | null;
  position2Overview: AllocatedSlot | null;
  allocationLog: AllocationLogEntry[];
}

// Phase 1 Output (Narrative Writer)
export interface NarrativeWriterOutput {
  summary: {
    content: string;
    wordCount: number;
    sourcesUsed: string[];
  };
  careerHighlights: {
    slot: string;
    headline: string;
    content: string;
    sourceId: string;
    primaryVerb: string;
    wordCount: number;
  }[];
  metadata: {
    usedVerbs: string[];
    thematicAnchors: {
      primaryNarrative: string;
      distinctiveValue: string;
      keyProofPoints: string[];
      toneEstablished: string;
    };
  };
}

// Phase 2 Output (Detail Writer)
export interface DetailWriterOutput {
  position1: {
    overview: {
      content: string;
      sourceId: string;
      wordCount: number;
    };
    bullets: {
      slot: string;
      content: string;
      sourceId: string;
      primaryVerb: string;
      wordCount: number;
    }[];
  };
  position2: {
    overview: { content: string; sourceId: string; wordCount: number; };
    bullets: { slot: string; content: string; sourceId: string; primaryVerb: string; wordCount: number; }[];
  };
  metadata: {
    usedVerbs: string[];
  };
}

// Assembled Resume (Final Output)
export interface AssembledResume {
  header: {
    name: string;
    targetTitle: string;
    location: string;
    phone: string;
    email: string;
  };
  summary: string;
  careerHighlights: string[];
  positions: {
    company: string;
    title: string;
    location: string;
    startDate: string;
    endDate: string;
    overview: string;
    bullets: string[];
  }[];
  education: {
    school: string;
    degree: string;
    field: string;
  };
}
```

### JD Strategy Types (src/types/v2.ts)

```typescript
export interface JDStrategy {
  company: {
    name: string;
    industry: string;
    subIndustry?: string;
    industryKeywords: string[];
    competitors?: string[];
    cultureSignals: string[];
    companySpecificLanguage: string[];
  };
  role: {
    title: string;
    level: 'executive' | 'senior' | 'mid' | 'junior';
    function: string;
    functionKeywords: string[];
    scope: string;
    reportsTo?: string;
    keyStakeholders: string[];
  };
  requirements: {
    mustHave: Requirement[];
    niceToHave: Requirement[];
  };
  positioning: {
    primaryAngle: {
      angle: string;
      jdEvidence: string;
      contentImplication: string;
    };
    supportingAngles: {
      angle: string;
      jdEvidence: string;
      contentImplication: string;
    }[];
    narrativeDirection: string;
  };
  language: {
    termsToMirror: {
      jdTerm: string;
      naturalUsage: string;
      context: string;
    }[];
    termsToAvoid: string[];
    toneGuidance: string;
  };
  scoringSignals: {
    industries: string[];
    functions: string[];
    themes: string[];
  };
}
```

### Profile Types (src/types/profile.ts)

```typescript
export interface ProfileData {
  id: string;
  name: string;
  email: string;
  phone: string;
  location: string;
  defaultTitle: string;
  positions: PositionData[];
  education: EducationData;
}

export interface PositionData {
  order: number;
  company: string;
  title: string;
  location: string;
  startDate: string;
  endDate: string;
  overview: string;  // Static for P3-P6, AI-written for P1-P2
}

export interface EducationData {
  school: string;
  degree: string;
  field: string;
}
```

---

## Database Schema

### Sessions Table (src/drizzle/schema.ts)

```typescript
export const sessions = pgTable('sessions', {
  id: uuid('id').defaultRandom().primaryKey(),
  profileId: text('profile_id').default('default'),

  // Job Description
  jobDescription: text('job_description'),
  jdHash: text('jd_hash'),

  // V2 Pipeline Data (JSON columns)
  v2Session: jsonb('v2_session'),  // Full session state
  v2Status: text('v2_status'),      // Pipeline status

  // Results
  validationPassed: boolean('validation_passed'),
  validationScore: real('validation_score'),
  totalCost: real('total_cost'),

  // Metadata
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
});
```

### Content Tables

```typescript
export const contentItems = pgTable('content_items', {
  id: text('id').primaryKey(),
  category: text('category'),  // 'summary', 'career_highlight', 'bullet', 'overview'
  position: integer('position'),  // For bullets: 1, 2, 3, etc.
  content: text('content'),
  contentLong: text('content_long'),
  industryTags: text('industry_tags').array(),
  functionTags: text('function_tags').array(),
  themeTags: text('theme_tags').array(),
  embedding: vector('embedding', { dimensions: 1536 }),
  createdAt: timestamp('created_at').defaultNow(),
});
```

---

## Core Logic & Algorithms

### 1. Content Allocation (src/lib/pipeline/content-allocator.ts)

**Purpose**: Ensures each piece of content (and its variants) is used exactly once.

**Algorithm**:
1. Allocate summaries (separate pool, never conflict)
2. Allocate Career Highlights (highest priority, pick best scoring first)
3. For each selected CH, mark its base ID and all variants as "used"
4. Allocate P1 bullets from remaining pool
5. Allocate P2 bullets from remaining pool
6. Allocate overviews (separate from bullet pool)

```typescript
function getBaseId(contentId: string): string {
  // CH-05-V2 -> CH-05
  return contentId.replace(/-V\d+$/, '');
}

function isVariantOfUsed(contentId: string, usedBaseIds: Set<string>): boolean {
  return usedBaseIds.has(getBaseId(contentId));
}
```

### 2. Content Scoring (src/lib/content-selector-v2.ts)

**3-Level Scoring System**:
- Industry tags (3 points for exact match, 1 for partial)
- Function tags (3 points for exact match, 1 for partial)
- Theme tags (3 points for exact match, 1 for partial)

```typescript
function scoreTagOverlap(itemTags: string[], signalTags: string[]): { score: number; matched: string[] } {
  const normalizedItem = itemTags.map(t => t.toLowerCase());
  const normalizedSignals = signalTags.map(t => t.toLowerCase());

  for (const signal of normalizedSignals) {
    if (normalizedItem.includes(signal)) {
      score += 3;  // Exact match
    } else {
      // Partial match check
      for (const itemTag of normalizedItem) {
        if (itemTag.includes(signal) || signal.includes(itemTag)) {
          score += 1;
        }
      }
    }
  }
}
```

### 3. Two-Phase Writing

**Phase 1 (Narrative Writer)**:
- Input: JD Strategy + Allocated Content
- Output: Summary (140-160 words) + 5 Career Highlights (25-40 words each)
- Also outputs: usedVerbs[], thematicAnchors{}

**Phase 2 (Detail Writer)**:
- Input: JD Strategy + Allocated Content + Phase 1 Output
- Receives: bannedVerbs from Phase 1 (cannot reuse)
- Output: P1 overview + 4 bullets, P2 overview + 3 bullets

### 4. Validation Checks

```typescript
interface ValidationResult {
  verdict: 'pass' | 'fail' | 'warning';
  scores: {
    honesty: number;    // 0-10: Metrics match sources?
    coverage: number;   // 0-10: JD requirements covered?
    quality: number;    // 0-10: Voice, formatting, clarity
    format: number;     // 0-10: Word counts, no emdashes
  };
  issues: {
    blockers: ValidationIssue[];   // Fail if any
    warnings: ValidationIssue[];   // Pass with warning
  };
}
```

**Blocker Conditions** (cause validation failure):
- Honesty score < 7 (fabricated metrics)
- Any emdash (—) detected
- Summary word count outside 140-160
- Bullet word count outside 25-40

---

## Voice Guide

The system uses a dedicated Voice Guide to maintain consistent personality:

```typescript
export const UMBERTO_VOICE_GUIDE = `
## Voice Guide: Umberto Castaldo

### Who He Is
Brand strategist who believes great marketing solves business problems
through culturally relevant narratives. Bridges consulting rigor with
creative craft.

### His Voice
- Confident but not arrogant: States outcomes directly, lets results speak
- Outcomes-focused: Leads with impact, not process
- Direct: No hedging, no filler, no corporate-speak
- Strategic: Connects every tactic to business transformation
- Human: Writes like a person, not a LinkedIn bot

### Words He Would NEVER Use
- "Leveraged" / "Utilized" / "Spearheaded" / "Synergy"
- "Passion for..." / "Excited to..."
- "Seasoned professional" / "Results-driven"
- Any word ending in "-ize" when simpler word works

### Formatting Rules
- NEVER use emdashes (—). Use commas or periods.
- NEVER use semicolons in bullets
- Numbers > 10 as numerals, <= 10 as words
- Percentages: 5%, 43%
- Money: $727M, $2.8B

### Summary Guidance
- 140-160 words (HARD requirement)
- Open with distinctive hook, NOT "Umberto is..."
- Include 2-3 proof points relevant to TARGET role
- Show personality and point of view
- End with philosophy, not skill list
`;
```

---

## API Endpoints

### V2.1 Pipeline

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/v2.1/pipeline/start` | POST | Start analysis phase (JD -> Gap Review) |
| `/api/v2.1/pipeline/generate` | POST | Run generation phase (Writing -> Validation) |
| `/api/v2.1/session/[id]` | GET | Fetch session data |
| `/api/v2.1/session/[id]` | PATCH | Update session (after edits) |
| `/api/v2.1/refine` | POST | AI refinement of a section |
| `/api/v2.1/export-docx` | POST | Generate DOCX file |
| `/api/v2.1/content-bank` | GET | List all content items |

### Request/Response Examples

**POST /api/v2.1/pipeline/start**
```json
// Request
{
  "jobDescription": "Full job description text...",
  "profileId": "umberto-castaldo"
}

// Response
{
  "success": true,
  "sessionId": "uuid-here",
  "status": "gap-review",
  "jdStrategy": { /* JD analysis */ },
  "allocation": {
    "careerHighlights": 5,
    "p1Bullets": 4,
    "p2Bullets": 3
  },
  "gapAnalysis": {
    "overallCoverage": 8,
    "honestGaps": [],
    "warnings": []
  }
}
```

**POST /api/v2.1/pipeline/generate**
```json
// Request
{
  "sessionId": "uuid-here"
}

// Response
{
  "success": true,
  "status": "complete",
  "resumeMarkdown": "...",
  "validation": {
    "verdict": "pass",
    "scores": { "honesty": 9, "coverage": 8, "quality": 8, "format": 10 }
  },
  "costs": { "total": 0.84 }
}
```

---

## UI Components

### Interactive Resume Editor

The `/v2.1/view/[sessionId]` page provides:

1. **InteractiveResume.tsx**: Renders resume with clickable sections
   - Hover reveals edit button
   - Shows word counts per section
   - Displays source IDs

2. **SectionEditor.tsx**: Modal for editing sections
   - Manual text editing
   - AI refinement with feedback
   - Real-time word count

3. **ContentBankSidebar.tsx**: Browse content library
   - Filter by category
   - See used vs available
   - Potential for source swapping

---

## Configuration Files

### next.config.mjs

```javascript
const nextConfig = {
  experimental: {
    serverActions: {
      bodySizeLimit: '10mb',
    },
  },
};
```

### tsconfig.json

```json
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "strict": true,
    "paths": {
      "@/*": ["./src/*"]
    }
  }
}
```

### drizzle.config.ts

```typescript
export default defineConfig({
  schema: './src/drizzle/schema.ts',
  out: './drizzle',
  dialect: 'postgresql',
  dbCredentials: {
    url: process.env.POSTGRES_URL!,
  },
});
```

---

## Environment Variables

| Variable | Purpose |
|----------|---------|
| `POSTGRES_URL` | Vercel Postgres connection string |
| `OPENAI_API_KEY` | For embeddings (text-embedding-3-small) |
| `ANTHROPIC_API_KEY` | For Claude (claude-sonnet-4-20250514) |

---

## Git History (Recent)

| Hash | Message | Date |
|------|---------|------|
| 0bd5382 | fix: calculate word counts from actual displayed content | 2026-01-06 |
| 4462c38 | fix: use useParams() hook in diagnostics pages | 2026-01-06 |
| ae278b5 | fix(v2.1): use useParams instead of use() for client component | 2026-01-06 |
| bf495ee | feat(v2.1): add interactive resume editing experience | 2026-01-06 |
| 23d0729 | feat(v2.1): add download DOCX and diagnostics page | 2026-01-06 |
| ab99ed0 | fix(v2.1): only fail validation on honesty blockers | 2026-01-06 |
| acd517a | fix(v2.1): enforce strict word counts in writer prompts | 2026-01-06 |
| 2e555c3 | feat(v2.1): show gap/warning details and add context input | 2026-01-06 |
| 6658c3f | feat(v2.1): add assembler and complete pipeline | 2026-01-06 |
| 9d80087 | feat(v2.1): add detail writer (Phase 2) | 2026-01-06 |
| 0c8169d | feat(v2.1): add voice guide and narrative writer (Phase 1) | 2026-01-06 |
| 8005e75 | feat(v2.1): add content allocator and profile types | 2026-01-06 |

---

## Known Issues

| Issue | Status | Impact |
|-------|--------|--------|
| No session resume via URL param | Open | Browser refresh loses UI state |
| No transaction wrapping | Open | Read-modify-write race conditions |
| No auth/rate limiting | Open | Low priority for MVP |
| No session cleanup/expiry | Open | Sessions persist indefinitely |

---

## Likely Next Steps

1. **Production Testing**: Full E2E with various JDs
2. **UX Polish**: Better error handling, loading states
3. **Session Persistence**: URL params for session resume
4. **Content Bank Expansion**: More variants for better coverage

---

## Critical Conventions

### Content Honesty
- **NEVER fabricate metrics** - All numbers must come from source material
- **NEVER invent achievements** - Only reframe existing content
- Validator enforces this with honesty score check

### Word Count Rules
- Summary: 140-160 words (hard requirement)
- Career Highlights: 25-40 words each
- Position Bullets: 25-40 words each
- Position Overviews: 40-60 words

### Formatting
- NO emdashes (—) ever
- NO semicolons in bullets
- Complete sentences only
- Numbers > 10 as numerals

### Content ID Conventions
- `SUM-XX`: Summary sources
- `CH-XX`: Career highlight base
- `CH-XX-VY`: Career highlight variant
- `P1-BXX`: Position 1 bullet base
- `P1-BXX-VY`: Position 1 bullet variant
- `OV-P1-XX`: Position 1 overview variant

---

## For Codex: Quick Reference

### Key Files to Modify

| Task | Primary File(s) |
|------|-----------------|
| Change prompts | `src/lib/prompts/*.ts` |
| Modify pipeline flow | `src/lib/pipeline/v2.1-pipeline.ts` |
| Update validation | `src/lib/agents/validator-v21.ts` |
| Add content | `src/data/master-content.json` |
| Change scoring | `src/lib/content-selector-v2.ts` |
| UI changes | `src/components/v21/*.tsx` |

### Running Locally

```bash
# Install dependencies
npm install

# Run development server
npm run dev

# Database operations
npm run db:generate  # Generate migrations
npm run db:push      # Push to database
npm run db:seed      # Seed content
```

### Common Operations

```bash
# Deploy to Vercel
git push origin main

# Type check
npx tsc --noEmit

# Pull env vars
vercel env pull
```

---

*This dossier was generated by Claude Code for seamless context transfer to OpenAI Codex.*
